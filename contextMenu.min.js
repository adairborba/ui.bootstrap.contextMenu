angular.module("ui.bootstrap.contextMenu",[]).directive("contextMenu",["$parse","$q",function(e,n){var t=[],o=function(e){for(;t.length&&(!e||t.length>e);)t.pop().remove();0==t.length&&a&&a.remove()},a=null,r=function(e,l,i,u,c){if(c||(c=0),!s)var s=angular.element;s(l.currentTarget).addClass("context");var d=s("<div>");a?d=a:a=d;var p=26;d.addClass("dropdown clearfix");var f=s("<ul>");f.addClass("dropdown-menu"),f.attr({role:"menu"});var g=p*i.length;window.innerHeight-g<l.pageY&&(l.pageY=window.innerHeight-g-10),f.css({display:"block",position:"absolute",left:l.pageX+"px",top:l.pageY+"px","z-index":1e4}),angular.forEach(i,function(t,a){var i=s("<li>");if(null===t)i.addClass("divider");else{var d=angular.isArray(t[1])?t[1]:angular.isArray(t[2])?t[2]:angular.isArray(t[3])?t[3]:null,p=s("<a>");p.css("padding-right","8px"),p.attr({tabindex:"-1",href:"#"});var g="string"==typeof t[0]?t[0]:t[0].call(e,e,l,u),m=t[2];n.when(g).then(function(e){p.text(e),d&&(p.css("cursor","default"),p.append(s('<strong style="font-family:monospace;font-weight:bold;float:right;">&gt;</strong>')))}),i.append(p);var v=angular.isFunction(t[2])?t[2].call(e,e,l,u,g,m):!0;if(v){var h=function(n){o(c+1);var t={pageX:l.pageX+f[0].offsetWidth-1,pageY:f[0].offsetTop+i[0].offsetTop-3};r(e,t,d,u,c+1)};i.on("click",function(n){n.preventDefault(),e.$apply(function(){d?h(n):(s(l.currentTarget).removeClass("context"),o(),t[1].call(e,e,l,u,g,m))})}),i.on("mouseover",function(n){e.$apply(function(){d&&h(n)})})}else i.on("click",function(e){e.preventDefault()}),i.addClass("disabled")}f.append(i)}),d.append(f);var m=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight);d.css({width:"100%",height:m+"px",position:"absolute",top:0,left:0,zIndex:9999}),s(document).find("body").append(d),d.on("mousedown",function(e){s(e.target).hasClass("dropdown")&&(s(l.currentTarget).removeClass("context"),o())}).on("contextmenu",function(e){s(e.currentTarget).removeClass("context"),e.preventDefault(),o(c)}),e.$on("$destroy",function(){o()}),t.push(f)};return function(e,n,t){n.on("contextmenu",function(n){n.stopPropagation(),e.$apply(function(){n.preventDefault();var o=e.$eval(t.contextMenu),a=e.$eval(t.model);if(!(o instanceof Array))throw'"'+t.contextMenu+'" not an array';0!==o.length&&r(e,n,o,a)})})}}]);